<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
	<script type="text/javascript" th:src="@{/webjars/jquery/jquery.min.js}" ></script>
	<script type="text/javascript" th:src="@{/webjars/bootstrap/js/bootstrap.min.js}" ></script>
	<script type="text/javascript" th:src="@{/js/common.js}" ></script>
	<link rel="stylesheet" type="text/css" th:href="@{/webjars/bootstrap/css/bootstrap.min.css}" />
	<link rel="stylesheet" type="text/css" th:href="@{/fontawesome/all.css}" />
	<link rel="stylesheet" type="text/css" th:href="@{/style.css}" />	
<head th:replace="fragments :: page_head('Shopping Cart', 'none')" />
<body>
<div class="container-fluid">
	<div th:replace="navigation :: header_menu"></div>
	<div th:replace="navigation :: search_nav"></div>

	<div class="text-center">
		<h2>Your Shopping Cart</h2>
	</div>

	<div class="row m-1">
		<div class="col-sm-8">
			<th:block th:each="item, status : ${cartItems}">
			<div class="row border rounded p-1" th:with="product = ${item.product}">
				<div class="col-1">
					<div>[[${status.count}]]</div>
					<div>
						<a class="fa-solid fa-trash linkRemove" th:rowNumber="${status.count}" 
							th:href="@{'/cart/remove/' + ${product.id}}"></a>
					</div>
				</div>
				<div class="col-3">
					<img th:src="@{${product.mainImagePath}}" class="img-fluid" />
				</div>
				<div class="col-6">
					<div>
						<a th:href="@{'/p/' + ${product.alias}}" target="_blank"
							th:title="${product.name}">
							<b>[[${product.shortName}]]</b>
						</a>
					</div>
			
				<input type="text" th:value="${item.quantity}" th:id="'quantity' + ${productId}" 
					onkeydown="return false;" 
					class="form-control text-center" style="width: 55px" />
						

					<div>
						<div th:replace="product/product_fragment :: product_price"></div>
					</div>				
				</div>
			</div>
			<div class="row m-1">&nbsp;</div>
			</th:block>
		</div>

		<div class="col-sm-4" th:unless="${#lists.isEmpty(cartItems)}">

			<div class="mt-2">
				<button class="btn btn-danger p-3 mt-2">Check Out</button>
			</div>
		</div>
	</div>	

	<div class="text-center" th:if="${#lists.isEmpty(cartItems)}">
		<h3>You have not chosen any products yet.</h3>
	</div>

	<div th:replace="navigation :: footer_menu"></div>
</div>	

<script type="text/javascript">

	$(".linkRemove").on("click", function(evt) {
		evt.preventDefault();
		removeProduct($(this));
	});	
	
	function removeProduct(link) {
	url = link.attr("href");

	$.ajax({
		type: "DELETE",
		url: url,
		beforeSend: function(xhr) {
			xhr.setRequestHeader(csrfHeaderName, csrfValue);
		}
	}).done(function(response) {
		rowNumber = link.attr("rowNumber");
		removeProductHTML(rowNumber);
		updateTotal();
		updateCountNumbers();

		showModalDialog("Shopping Cart", response);

	}).fail(function() {
		showErrorModal("Error while removing product.");
	});				
}

function removeProductHTML(rowNumber) {
	$("#row" + rowNumber).remove();
	$("#blankLine" + rowNumber).remove();
}

function updateCountNumbers() {
	$(".divCount").each(function(index, element) {
		element.innerHTML = "" + (index + 1);
	}); 
}
</script>
</body>
</html>